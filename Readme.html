<h1>pyheart4fish - a heart beat analysis tool for zebrafish</h1>
<!--README file was written according to: 
https://medium.com/analytics-vidhya/how-to-create-a-readme-md-file-8fb2e8ce24e3-->
<h2>Content</h2>
<ol>
<li>Requirements / Dependencies</li>
<li>How to run pyheart4fish - Tutorial/ Documentation</li>
<li>Troubleshooting and FAQ</li>
<li>Licensing</li>
</ol>
<hr />
<h2>Requirements / Dependencies</h2>
<p>The pyheart4fish has been developed and tested in <strong>windows 11</strong>! <br/>
Supported Python versions &gt;= 3.6. &gt;&gt;&gt; https://www.python.org/downloads/</p>
<p>Required python packages:</p>
<ul>
<li>aicsimageio==4.7.0</li>
<li>czifile==2019.7.2</li>
<li>aicspylibczi==3.0.5</li>
<li>matplotlib==3.5.1</li>
<li>numpy==1.21.2</li>
<li>opencv_python==4.5.5.62</li>
<li>pandas==1.3.4</li>
<li>Pillow==9.2.0</li>
<li>scipy==1.8.0</li>
<li>openpyxl==3.0.10
<br/>
<code>python insall -r requirements.txt</code></li>
</ul>
<hr />
<h2>How to run pyheart4fish - Tutorial/ Documentation</h2>
<h3>Installation</h3>
<ol>
<li>Download the complete pyheart4fish folder and run Python scripts</li>
<li>Download pyheart4fish_exe folder and run .exe file</li>
<li>use Docker image (not yet implemented)</li>
</ol>
<h3>Run heart_beat_GUI.py</h3>
<ol>
<li>in console <code>python .../pyHeart4Fish_GUI/heart_beat_GUI.py</code>2</li>
<li>or right click on file &gt; open with Python</li>
<li>run in Python IDE of your choice (e.g., Pycharm, KITE, Notepad++)</li>
</ol>
<h3>Input data types</h3>
<ul>
<li>.avi</li>
<li>.czi (ZEISS file format)</li>
<li>.mp4 (not supported yet! Coming soon!)</li>
<li>.tif-files, .png-files or .jpg-files 
as series of frames stored in one folder per fish</li>
</ul>
<h3>Outputs stored in the results folder</h3>
<ul>
<li>Config-file as json-file</li>
<li>Raw data of heart beats as numpy array</li>
<li>Atrium and ventricle curves and fitting functions as plot</li>
<li>Processed heart images as gif-file (10 iterations)</li>
<li>Excel sheet for each fish in subfolder with all possible parameters</li>
<li>Combined Excel sheet for all fish analyzed</li>
</ul>
<h3>Test data sets in &gt;Test_data&lt; folder</h3>
<ul>
<li><strong>avi_files</strong> and avi_files_Results_example</li>
<li>frames per seconds = 29 and cut movie at = 20 sec</li>
<li><strong>czi-files</strong> and czi-files_Results_example</li>
<li>frames per seconds = 9.5 and cut movie at = 20 sec</li>
<li><strong>tif_files</strong> and tif_files_Results_example </li>
<li>frames per seconds = 6 and cut movie at = 6 sec<ul>
<li>bad example as too few frames per sec</li>
</ul>
</li>
</ul>
<h3>Select input and output folder and set configurations</h3>
<p><img alt="Main Window" src="Screenshots_tutorial/1_main_window.jpeg" /></p>
<table border="1">
  <tr>
    <td><b>Input folder</b>:</td>
    <td>contains all movie-files/ images in sub-folders for one project/ experiment </td>
   </tr>
  <tr>
     <td><b>Output folder</b>: </td>
     <td>
        > is automatically create: input + "_Results" <br/> 
        > click >Change output< 
     </td>
  </tr>
  <tr>
    <td><b> Frames per second: </b> </td>
    <td> should be > 15 for optimal results </td>
  </tr>
  <tr>
     <td> <b> Skip images: </b> </td>
     <td> > default 0, (0 - 10 possible) <br/>
          > 1 = every second frame is skipped  <br/>
          > might accelerate the process as the number of images is cut half <br/>
          > use only if frame rate is high enough! 
          </td>
  </tr>
  <tr>
     <td> <b> Pixel size: </b> </td>
     <td> > Please check the size of a pixel at your microscope <br/>
          > a wrong pixel size will give wrong heart size etc.  <br/>
          </td>
  </tr> 
  <tr>
     <td> <b> Cut movie (sec): </b> </td>
     <td> > the length of the movie should be at least 10 s <br/>
          > ensures that all movies have the same length  <br/>
          </td>
  </tr>
  <tr>
     <td> <b> File format: </b> </td>
     <td> see > <b> Input data types </b>
          </td>
  </tr>
  <tr>
     <td> <b> Overwrite data: </b> </td>
     <td> > if data need to be re-analyzed <br/>
          > if unselected all analyzed hearts will be skipped in the project folder
          </td>
  </tr>

</table>

<p>By clicking <code>Start</code> the script <code>heart_beat_GUI_MAIN.py</code> is executed which iteratively <br/>
executes <code>heart_beat_GUI_only_one_fish_multiprocessing.py</code> and <br/>
combines all Excel sheets once all fish have been analyzed.
<br/></p>
<h3>Rotate heart</h3>
<p>Rotate the heart using the slider to position ventricle  at the top and atrium at the bottom.
Click <code>OK</code> to continue.</p>
<p><img alt="Rotate" src="Screenshots_tutorial/2_rotate_heart_small.jpeg" /></p>
<h3>Define atrium and ventricle</h3>
<p>To distinguish between background and heart define 1) atrium and 2) ventricle area by <code>Drag-and-Draw</code>.
Click <code>OK</code> to start the analysis of all frames / images.</p>
<p><img alt="" src="Screenshots_tutorial/3_define_heart_areas_small.jpeg" /></p>
<p>The first processed images is shown after the complete analysis.
Press  <code>YES</code> to show heart beat curves. <br/></p>
<p>The number of analyzed fish hearts is shown in the left top corner (here: 1/2 analyzed)</p>
<p><img alt="" src="Screenshots_tutorial/4_progress_bar.jpeg" /></p>
<p><img alt="" src="Screenshots_tutorial/5_show_results_small.jpeg" /></p>
<h3>Heartbeat curves</h3>
<ul>
<li><strong>freq:</strong> frequency / rate of heartbeats derived from fitting sine function</li>
<li><strong>fft_freq:</strong> frequency / rate of heartbeats derived from fast fourier transformation (FFT)</li>
<li><strong>phase shift:</strong> shift between atrium and ventricle
  <br/> &emsp; &gt; A very small or very high phase shift can be a sign of arrhythmia / AV-block</li>
<li><strong>arrhythmia score:</strong> The lower this value, the more regular the heartbeat.
  <br/> &emsp; &gt; a value &gt;0.7 is sign of arrhythmia</li>
<li><strong>av-block score:</strong> the absolute difference of all frequencies (freq and fft_freq) between atrium and ventricle
  <br/> &emsp; &gt; a value &gt;0.5 is a sign</li>
</ul>
<p><img alt="" src="Screenshots_tutorial/6_heart_beat_curves._small.jpeg" /></p>
<h3>Excel sheet for all heart movies analyzed</h3>
<p>Once all fish hearts have been analyzed you can choose to open the summary Excel sheet for all fish</p>
<p><img alt="" src="Screenshots_tutorial/7_open_excel_sheet.jpeg" /></p>
<hr />
<h2>Troubleshooting and FAQ</h2>
<ul>
<li>make sure that the background fluorescence is as low as possible  </li>
<li>In step 2, make sure you correctly select the atrium (in most case less bright part of the fish),<br/>
otherwise the background threshold is set incorrectly </li>
<li>if the heart hasn't been found correctly, please try to redefine atrium and ventricle area </li>
</ul>
<blockquote>
<p><strong>Please contact tobias.reinberger@uni-luebeck.de to report issues</strong></p>
</blockquote>
<hr />
<h2>Licensing</h2>
<hr />